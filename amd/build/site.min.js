define(["core/log","core/ajax"],function(r,s){"use strict";function t(e){this.rootel=e,this.editingsetup=!1}return t.prototype.main=function(){var o=this,e=(o.setupEditing(),document.querySelector(".site-editor-switch")),e=(e&&e.addEventListener("change",e=>{let t=0;e.currentTarget.checked?(o.rootel.dataset.mode="edit",t=1,o.setupEditing()):(o.rootel.dataset.mode="view",o.disableBlockSorting(),o.disableSectionSorting()),s.call([{methodname:"mod_website_apicontrol",args:{action:"update_mode",data:JSON.stringify({mode:t})}}])}),document.querySelector(".btn-fullscreen")),e=(e&&e.addEventListener("click",e=>{document.body.classList.contains("fullscreen")?document.body.classList.remove("fullscreen"):document.body.classList.add("fullscreen")}),"1"==o.rootel.dataset.canedit&&(document.querySelectorAll("[data-formurl]").forEach(e=>{e.addEventListener("click",e=>{var t;e.preventDefault(),e.stopPropagation(),"edit"!==o.rootel.dataset.mode||document.querySelector(".site-sections").classList.contains("sorting")||(e=e.currentTarget.dataset.formurl)&&((t=document.querySelector("#modal-embeddedform .modal__body")).dataset.currentform!=e&&(t.dataset.currentform=e,t.innerHTML='<iframe src="'+e+'"></iframe>'),document.getElementById("modal-state-embeddedform").checked=!0)})}),document.querySelectorAll(".editzone").forEach(e=>{e.addEventListener("mouseenter",e=>{e.stopPropagation(),"edit"===o.rootel.dataset.mode&&(document.querySelectorAll(".editzone.hover").forEach(e=>{e.classList.remove("hover")}),e.target.classList.add("hover"))}),e.addEventListener("mouseleave",e=>{e.target.classList.remove("hover"),e.toElement&&e.toElement.classList.contains("editzone")?e.toElement.classList.add("hover"):e.toElement.parentNode.classList.contains("editzone")&&e.toElement.parentNode.classList.add("hover")})})),o.checkMenuWidth(),window.addEventListener("resize",function(e){o.checkMenuWidth()},!0),document.querySelector(".menutoggle")),e=(e&&e.addEventListener("click",e=>{var t=document.querySelector(".menu");t.classList.contains("expanded")?t.classList.remove("expanded"):t.classList.add("expanded")}),document.querySelectorAll(".menuitem.haschildren > a").forEach(t=>{t.addEventListener("click",e=>{document.querySelector(".menuwrap").classList.contains("mobile")&&(e.preventDefault(),t.parentNode.classList.contains("expanded")?t.parentNode.classList.remove("expanded"):t.parentNode.classList.add("expanded"))})}),document.querySelectorAll('.site-section[data-collapsible="true"] .section-title').forEach(e=>{e.addEventListener("click",e=>{e.currentTarget.parentNode.classList.contains("collapsed")?e.currentTarget.parentNode.classList.remove("collapsed"):e.currentTarget.parentNode.classList.add("collapsed")})}),document.querySelector(".btn-sort-sections"));e&&e.addEventListener("click",e=>{e.preventDefault();e=document.querySelector(".site-sections");e.classList.contains("sorting")?(o.disableSectionSorting(),e.classList.remove("sorting")):(o.enableSectionSorting(),e.classList.add("sorting"))})},t.prototype.checkMenuWidth=function(){var e=document.querySelector(".topbar-right"),t=document.querySelector(".menuwrap"),o=document.querySelector(".topbar"),i=document.querySelector(".logo"),e=(t.classList.add("checkingsize"),t.classList.remove("mobile"),e.offsetWidth);o.offsetWidth-i.offsetWidth-50<e&&t.classList.add("mobile"),t.classList.remove("checkingsize")},t.prototype.setupEditing=function(){var e=this;if("edit"===e.rootel.dataset.mode)return"undefined"!=typeof Sortable&&(0!==document.querySelectorAll(".section-blocks").length&&(e.editingsetup&&(e.enableBlockSorting(),e.enableSectionSorting()),e.editingsetup=!0,e.initBlockSorting(),void e.initSectionSorting()))},t.prototype.BlockSortStart=function(e){var t=document.querySelector(".site-root");"edit"===t.dataset.mode&&(t.classList.add("sorting"),document.querySelectorAll(".site-section").forEach(e=>{e.style.width=e.offsetWidth+"px",e.style.height=e.offsetHeight+"px",e.style.overflow="hidden"}))},t.prototype.BlockSortEnd=function(t){var o=document.querySelector(".site-root");if("edit"===o.dataset.mode){o.classList.remove("sorting"),document.querySelectorAll(".site-section").forEach(e=>{e.style.width="",e.style.height="",e.style.overflow=""}),r.debug(t.from),r.debug(t.to);let e=[];for(const i of t.from.children)i.dataset.blockid&&e.push(i.dataset.blockid);if(s.call([{methodname:"mod_website_apicontrol",args:{action:"reorder_blocks",data:JSON.stringify({sectionid:t.from.parentNode.dataset.sectionid,blocks:JSON.stringify(e)})}}]),e=[],t.from.parentNode.dataset.sectionid!=t.to.parentNode.dataset.sectionid){for(const n of t.to.children)n.dataset.blockid&&e.push(n.dataset.blockid);s.call([{methodname:"mod_website_apicontrol",args:{action:"reorder_blocks",data:JSON.stringify({sectionid:t.to.parentNode.dataset.sectionid,blocks:JSON.stringify(e)})}}])}}},t.prototype.SectionSortStart=function(e){var t=document.querySelector(".site-root");"edit"===t.dataset.mode&&t.classList.add("sorting-sections")},t.prototype.SectionSortEnd=function(e){var o=document.querySelector(".site-root");if("edit"===o.dataset.mode){o.classList.remove("sorting-sections");let t=[];document.querySelectorAll(".site-section").forEach(e=>{e.dataset.sectionid&&t.push(e.dataset.sectionid)}),s.call([{methodname:"mod_website_apicontrol",args:{action:"reorder_sections",data:JSON.stringify({pageid:o.dataset.currentpage,sections:JSON.stringify(t)})}}])}},t.prototype.initBlockSorting=function(){let t=this;document.querySelectorAll(".section-blocks").forEach(e=>{new Sortable(e,{group:"sharedsections",draggable:".site-block",animation:150,ghostClass:"reordering",onStart:t.BlockSortStart,onEnd:t.BlockSortEnd})})},t.prototype.disableBlockSorting=function(){document.querySelectorAll(".section-blocks").forEach(e=>{e=Sortable.get(e);void 0!==e&&e.option("disabled",!0)})},t.prototype.enableBlockSorting=function(){document.querySelectorAll(".section-blocks").forEach(e=>{e=Sortable.get(e);void 0!==e&&e.option("disabled",!1)})},t.prototype.initSectionSorting=function(){var e=document.querySelector(".site-sections");new Sortable(e,{draggable:".site-section",animation:150,ghostClass:"reordering",onStart:this.SectionSortStart,onEnd:this.SectionSortEnd})},t.prototype.disableSectionSorting=function(){var e=document.querySelector(".site-sections"),e=Sortable.get(e);void 0!==e&&e.option("disabled",!0)},t.prototype.enableSectionSorting=function(){var e=document.querySelector(".site-sections"),e=Sortable.get(e);void 0!==e&&e.option("disabled",!1)},{init:function(){r.debug("mod_website/site: initializing");var e=document.querySelector(".site-root");null===e?r.error("mod_website/site: .site-root not found!"):new t(e).main()}}});