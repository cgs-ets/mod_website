define(["core/log","core/ajax"],function(t,r){"use strict";function o(e){this.rootel=e,this.editingsetup=!1}return o.prototype.main=function(){var o=this,e=(o.setupEditing(),document.querySelector(".site-editor-switch")),e=(e&&e.addEventListener("change",e=>{let t=0;e.currentTarget.checked?(o.rootel.dataset.mode="edit",t=1,o.setupEditing()):(o.rootel.dataset.mode="view",document.querySelectorAll(".site-section").forEach(e=>{e=Sortable.get(e);void 0!==e&&e.option("disabled",!0)})),r.call([{methodname:"mod_website_apicontrol",args:{action:"update_mode",data:JSON.stringify({mode:t})}}])}),"1"==o.rootel.dataset.canedit&&document.querySelectorAll(".editzone").forEach(e=>{e.addEventListener("click",e=>{e.stopPropagation(),"edit"===o.rootel.dataset.mode&&(e=e.currentTarget.dataset.url)&&(window.location.href=e)}),e.addEventListener("mouseenter",e=>{document.querySelectorAll(".editzone.hover").forEach(e=>{e.classList.remove("hover")}),e.target.classList.add("hover")}),e.addEventListener("mouseleave",e=>{e.target.classList.remove("hover"),e.toElement&&(e.toElement.classList.contains("editzone")||e.toElement.parentNode.classList.contains("editzone"))&&e.toElement.classList.add("hover")})}),o.checkMenuWidth(),window.addEventListener("resize",function(e){o.checkMenuWidth()},!0),document.querySelector(".menutoggle"));e&&e.addEventListener("click",e=>{var t=document.querySelector(".menu");t.classList.contains("expanded")?t.classList.remove("expanded"):t.classList.add("expanded")}),document.querySelectorAll(".menuitem.haschildren > a").forEach(t=>{t.addEventListener("click",e=>{document.querySelector(".menuwrap").classList.contains("mobile")&&(e.preventDefault(),t.parentNode.classList.contains("expanded")?t.parentNode.classList.remove("expanded"):t.parentNode.classList.add("expanded"))})}),document.querySelectorAll('.site-section[data-collapsible="true"] .section-title').forEach(e=>{e.addEventListener("click",e=>{e.currentTarget.parentNode.classList.contains("collapsed")?e.currentTarget.parentNode.classList.remove("collapsed"):e.currentTarget.parentNode.classList.add("collapsed")})})},o.prototype.checkMenuWidth=function(){var e=document.querySelector(".topbar-right"),t=document.querySelector(".menuwrap"),o=document.querySelector(".topbar"),i=document.querySelector(".logo"),e=(t.classList.add("checkingsize"),t.classList.remove("mobile"),e.offsetWidth);o.offsetWidth-i.offsetWidth-50<e&&t.classList.add("mobile"),t.classList.remove("checkingsize")},o.prototype.setupEditing=function(){var e,t=this;if("edit"===t.rootel.dataset.mode)return"undefined"!=typeof Sortable&&(0!==(e=document.querySelectorAll(".section-blocks")).length&&(t.editingsetup&&e.forEach(e=>{e=Sortable.get(e);void 0!==e&&e.option("disabled",!1)}),t.editingsetup=!0,void e.forEach(e=>{new Sortable(e,{group:"sharedsections",draggable:".site-block",animation:150,ghostClass:"reordering",onStart:t.BlockSortStart,onEnd:t.BlockSortEnd})})))},o.prototype.BlockSortStart=function(e){var t=document.querySelector(".site-root");"edit"===t.dataset.mode&&(t.classList.add("sorting"),document.querySelectorAll(".site-section").forEach(e=>{e.style.width=e.offsetWidth+"px",e.style.height=e.offsetHeight+"px",e.style.overflow="hidden"}))},o.prototype.BlockSortEnd=function(t){var o=document.querySelector(".site-root");if("edit"===o.dataset.mode){o.classList.remove("sorting"),document.querySelectorAll(".site-section").forEach(e=>{e.style.width="",e.style.height="",e.style.overflow=""});let e=[];for(const i of t.from.children)i.dataset.blockid&&e.push(i.dataset.blockid);if(r.call([{methodname:"mod_website_apicontrol",args:{action:"reorder_blocks",data:JSON.stringify({sectionid:t.from.dataset.sectionid,blocks:JSON.stringify(e)})}}]),e=[],t.from.className!=t.to.className){for(const s of t.to.children)s.dataset.blockid&&e.push(s.dataset.blockid);r.call([{methodname:"mod_website_apicontrol",args:{action:"reorder_blocks",data:JSON.stringify({sectionid:t.to.dataset.sectionid,blocks:JSON.stringify(e)})}}])}}},o.prototype.SectionSortStart=function(e){var t=document.querySelector(".site-root");"edit"===t.dataset.mode&&t.classList.add("sorting-sections")},o.prototype.SectionSortEnd=function(e){var t=document.querySelector(".site-root");"edit"===t.dataset.mode&&t.classList.remove("sorting-sections")},{init:function(){t.debug("mod_website/site: initializing");var e=document.querySelector(".site-root");null===e?t.error("mod_website/site: .site-root not found!"):new o(e).main()}}});