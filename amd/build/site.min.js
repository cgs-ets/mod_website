define(["core/log","core/ajax","core/config"],function(i,s,r){"use strict";function t(e){this.rootel=e,this.editingawake=!1}return t.prototype.main=function(){var n=this,e=(n.wakeupEditing(),document.querySelector(".site-editor-switch")),e=(e&&e.addEventListener("change",e=>{let t=0;e.currentTarget.checked?(n.rootel.dataset.mode="edit",t=1,n.wakeupEditing()):(n.rootel.dataset.mode="view",n.disableBlockSorting(),n.disableSectionSorting()),s.call([{methodname:"mod_website_apicontrol",args:{action:"update_mode",data:JSON.stringify({mode:t})}}])}),document.querySelector(".btn-fullscreen"));if(e&&e.addEventListener("click",e=>{document.body.classList.contains("fullscreen")?document.body.classList.remove("fullscreen"):document.body.classList.add("fullscreen")}),document.querySelectorAll(".picturebutton-type-content").forEach(t=>{t.addEventListener("click",e=>{"edit"!==n.rootel.dataset.mode&&(e.preventDefault(),e.stopPropagation(),e=t.querySelector(".picturebutton-content"),document.querySelector("#modal-popupcontent .modal__body").innerHTML=e.innerHTML,document.getElementById("modal-state-popupcontent").checked=!0)})}),"1"==n.rootel.dataset.caneditpage){document.querySelectorAll("[data-formurl]").forEach(e=>{e.addEventListener("click",e=>{var t;"edit"===n.rootel.dataset.mode&&(e.preventDefault(),e.stopPropagation(),document.querySelector(".site-sections").classList.contains("sorting")||(e=e.currentTarget.dataset.formurl)&&((t=document.querySelector("#modal-embeddedform .modal__body")).dataset.currentform!=e&&(t.dataset.currentform=e,t.innerHTML='<iframe src="'+e+'"></iframe>'),document.getElementById("modal-state-embeddedform").checked=!0))})}),document.querySelectorAll(".editzone").forEach(e=>{e.addEventListener("mouseenter",e=>{"edit"===n.rootel.dataset.mode&&(e.stopPropagation(),document.querySelectorAll(".editzone.hover").forEach(e=>{e.classList.remove("hover")}),e.target.classList.add("hover"))}),e.addEventListener("mouseleave",e=>{"edit"===n.rootel.dataset.mode&&(e.target.classList.remove("hover"),e.toElement&&e.toElement.classList.contains("editzone")?e.toElement.classList.add("hover"):e.toElement.parentNode.classList.contains("editzone")&&e.toElement.parentNode.classList.add("hover"))})}),Dropzone.autoDiscover=!1;let o=document.querySelector(".site-root");document.querySelectorAll(".site-section").forEach(e=>{var t=r.wwwroot+"/mod/website/dropzone.php?site="+o.dataset.siteid+"&section="+e.dataset.sectionid+"&upload=1&sesskey="+r.sesskey,e=new Dropzone(e,{url:t,clickable:!1});e.on("queuecomplete",function(e){setTimeout(location.reload(),2e3)}),e.on("error",function(e,t){console.log(t)}),e.on("addedfiles",function(){var e=document.getElementsByClassName("dz-preview"),t=document.createElement("div");t.className="dz-preview-wrapper",n.wrapAll(t,e)})})}n.checkMenuWidth(),window.addEventListener("resize",function(e){n.checkMenuWidth()},!0);e=document.querySelector(".menutoggle"),e&&e.addEventListener("click",e=>{var t=document.querySelector(".menu");t.classList.contains("expanded")?t.classList.remove("expanded"):t.classList.add("expanded")}),document.querySelectorAll(".menu > .menuitem.haschildren > a").forEach(t=>{t.addEventListener("click",e=>{document.querySelector(".menuwrap").classList.contains("mobile")&&(e.preventDefault(),t.parentNode.classList.contains("expanded")?t.parentNode.classList.remove("expanded"):t.parentNode.classList.add("expanded"))})}),document.querySelectorAll(".submenu > .menuitem.haschildren > a").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),t.parentNode.classList.contains("expanded")?t.parentNode.classList.remove("expanded"):t.parentNode.classList.add("expanded")})}),document.querySelectorAll('.site-section[data-collapsible="true"] .section-title').forEach(e=>{e.addEventListener("click",e=>{e.currentTarget.parentNode.classList.contains("collapsed")?e.currentTarget.parentNode.classList.remove("collapsed"):e.currentTarget.parentNode.classList.add("collapsed")})}),e=document.querySelector(".btn-sort-sections");e&&e.addEventListener("click",e=>{e.preventDefault();e=document.querySelector(".site-sections");e.classList.contains("sorting")?(n.disableSectionSorting(),e.classList.remove("sorting")):(n.enableSectionSorting(),e.classList.add("sorting"))}),n.rootel.classList.add("js-loaded")},t.prototype.checkMenuWidth=function(){var e=document.querySelector(".topbar-right"),t=document.querySelector(".menuwrap"),o=document.querySelector(".topbar"),n=document.querySelector(".logo"),e=(t.classList.add("checkingsize"),t.classList.remove("mobile"),e.offsetWidth);o.offsetWidth-n.offsetWidth-50<e&&t.classList.add("mobile"),t.classList.remove("checkingsize")},t.prototype.wakeupEditing=function(){var e=this;if("edit"===e.rootel.dataset.mode)return"undefined"!=typeof Sortable&&(0!==document.querySelectorAll(".section-blocks").length&&(e.editingawake&&(e.enableBlockSorting(),e.enableSectionSorting()),e.editingawake=!0,e.initBlockSorting(),void e.initSectionSorting()))},t.prototype.BlockSortStart=function(e){var t=document.querySelector(".site-root");"edit"===t.dataset.mode&&(t.classList.add("sorting"),document.querySelectorAll(".site-section").forEach(e=>{e.style.width=e.offsetWidth+"px",e.style.height=e.offsetHeight+"px",e.style.overflow="hidden"}))},t.prototype.BlockSortEnd=function(t){var o=document.querySelector(".site-root");if("edit"===o.dataset.mode){o.classList.remove("sorting"),document.querySelectorAll(".site-section").forEach(e=>{e.style.width="",e.style.height="",e.style.overflow=""}),i.debug(t.from),i.debug(t.to);let e=[];for(const n of t.from.children)n.dataset.blockid&&e.push(n.dataset.blockid);if(s.call([{methodname:"mod_website_apicontrol",args:{action:"reorder_blocks",data:JSON.stringify({sectionid:t.from.parentNode.dataset.sectionid,blocks:JSON.stringify(e)})}}]),e=[],t.from.parentNode.dataset.sectionid!=t.to.parentNode.dataset.sectionid){for(const r of t.to.children)r.dataset.blockid&&e.push(r.dataset.blockid);s.call([{methodname:"mod_website_apicontrol",args:{action:"reorder_blocks",data:JSON.stringify({sectionid:t.to.parentNode.dataset.sectionid,blocks:JSON.stringify(e)})}}])}}},t.prototype.SectionSortStart=function(e){var t=document.querySelector(".site-root");"edit"===t.dataset.mode&&t.classList.add("sorting-sections")},t.prototype.SectionSortEnd=function(e){var o=document.querySelector(".site-root");if("edit"===o.dataset.mode){o.classList.remove("sorting-sections");let t=[];document.querySelectorAll(".site-section").forEach(e=>{e.dataset.sectionid&&t.push(e.dataset.sectionid)}),s.call([{methodname:"mod_website_apicontrol",args:{action:"reorder_sections",data:JSON.stringify({pageid:o.dataset.currentpage,sections:JSON.stringify(t)})}}])}},t.prototype.initBlockSorting=function(){let t=this;document.querySelectorAll(".section-blocks").forEach(e=>{new Sortable(e,{group:"sharedsections",draggable:".site-block",animation:150,ghostClass:"reordering",onStart:t.BlockSortStart,onEnd:t.BlockSortEnd})})},t.prototype.disableBlockSorting=function(){document.querySelectorAll(".section-blocks").forEach(e=>{e=Sortable.get(e);void 0!==e&&e.option("disabled",!0)})},t.prototype.enableBlockSorting=function(){document.querySelectorAll(".section-blocks").forEach(e=>{e=Sortable.get(e);void 0!==e&&e.option("disabled",!1)})},t.prototype.initSectionSorting=function(){var e=document.querySelector(".site-sections");new Sortable(e,{draggable:".site-section",animation:150,ghostClass:"reordering",onStart:this.SectionSortStart,onEnd:this.SectionSortEnd})},t.prototype.disableSectionSorting=function(){var e=document.querySelector(".site-sections"),e=Sortable.get(e);void 0!==e&&e.option("disabled",!0)},t.prototype.enableSectionSorting=function(){var e=document.querySelector(".site-sections"),e=Sortable.get(e);void 0!==e&&e.option("disabled",!1)},t.prototype.wrapAll=function(e,t){var o=t.length?t[0]:t,n=o.parentNode;for(e.appendChild(o);t.length;)e.appendChild(t[0]);n.appendChild(e)},{init:function(){i.debug("mod_website/site: initializing");var e=document.querySelector(".site-root");null===e?i.error("mod_website/site: .site-root not found!"):new t(e).main()}}});