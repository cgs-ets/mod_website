define(["jquery","core/ajax","core/log","core/notification","mod_website/grading_form_change_check"],function(s,n,o,i,d){"use strict";function c(){}return c.prototype.main=function(){this.get_users(),this.saveGrading()},c.prototype.get_users=function(){var e=s('[data-region="user-selector"]').find("[data-action=change-user]"),t=e.attr("data-websiteid"),e=e.attr("data-groupid");return n.call([{methodname:"mod_website_get_participants",args:{websiteid:t,groupid:e},done:this._setUsers.bind(this),fail:i.exception}]),!0},c.prototype._setUsers=function(e){this.users=JSON.parse(e.users)},c.prototype.saveGrading=function(){var a,r=this;s('input[name="savechanges"').click(function(){a=s(this).attr("name")}),s('input[name="saveandshownext"').click(function(){a=s(this).attr("name")}),s("#gradeform").on("submit",function(e,t){var i=parseFloat(s("input").first().val());if(isNaN(i)||100<i||i<0)return s("#id_error_grade").removeAttr("hidden"),e.stopImmediatePropagation(),!1;s("#id_error_grade").attr("hidden",!0),s('[data-region="overlay"]').show(),e.preventDefault();i={userid:s('[data-region="user-info"]').attr("data-userid"),websiteid:String(s('[data-region="user-info"]').data("websiteid")),courseid:String(s('[data-region="website-info"]').data("courseid")),formdata:s(this).serialize()};n.call([{methodname:"mod_website_save_quick_grading",args:{grade:JSON.stringify(i)},done:r._handleFormSubmissionResponse.bind(this,a,t),fail:function(e){o.error(e)}}])})},c.prototype._handleFormSubmissionResponse=function(e,t){var i,a=s(".custom-select option:selected").val(),r=a==s("select.custom-select option:last-child").val();null!=t?null!=t.userid?i=t.userid:t.direction.includes("right")?(i=s("select.custom-select option:selected").next().val(),s(".custom-select option:selected").next().attr("selected","selected")):t.direction.includes("left")&&(s(".custom-select option:selected").prev().attr("selected","selected"),i=s("select.custom-select option").filter(":selected").val()):i=s("select.custom-select option:selected").next().val(),0<i?null!=e&&"savechanges"==e?""==s(".grade-input").val()&&"0.00"==s(".grade-input").val()||(s("span.gradedtag").removeAttr("hidden"),d.saveFormState("#gradeform")):null!=i&&0<i?(s(`select.custom-select option[value='${a}']`).removeAttr("selected"),s(`select.custom-select option[value='${i}']`).attr("selected","selected"),c.prototype.get_next_user(i,t)):0==i&&s(document).trigger("user-changed",i):0!=i&&null!=t?window.open(t.direction,"_self"):(d.saveFormState("#gradeform"),!r||null!=e&&"savechanges"==e||(s(`select.custom-select option[value='${a}']`).removeAttr("selected"),i=0,s("select.custom-select option[value='0']").attr("selected","selected"),s(document).trigger("user-changed",i),s("div#grading-panel-container").css("display","none"))),s('[data-region="overlay"]').hide()},c.prototype.get_next_user=function(i,e){var t=String(s('[data-region="user-info"]').data("websiteid"));n.call([{methodname:"mod_website_get_next_participant_details",args:{userid:i,websiteid:t},done:function(e){o.debug("Grade values retrieved successfuly."),s(document).trigger("user-changed",i);var t=new URL(window.location);t.searchParams.get("userid"),t.searchParams.set("userid",i),window.history.replaceState({},"",t),c.prototype.refreshGradePanel(e.html)},fail:function(e){o.error("mod_website_get_participant_by_id. Unable to get elements"),o.debug(e)}}])},c.prototype.refreshGradePanel=function(e){var t=s('[data-region="grade"]');t.fadeOut(300,function(){t.replaceWith(e),t.show(),s("#gradeform").on("submit",c.prototype.saveGrading()),d.saveFormState("#gradeform")})},{init:function(){o.debug("mod_website/SaveGrading: initializing SaveGrading of the mod_website"),(new c).main()}}});