define(["jquery","core/notification","core/ajax","core/str","mod_website/save_grading","mod_website/grading_form_change_check"],function(r,o,n,s,i,a){function c(e){console.log(" GradingNavigation constructor...."),this._regionSelector=e,this._region=r(e),this._users=[],this._gradeFeedbackChanged=!1,this._loadAllUsers(),this._previousformvales=a.saveFormState("#gradeform"),this._region.find('[data-action="previous-user"]').on("click",this._handlePreviousUser.bind(this)),this._region.find('[data-action="next-user"]').on("click",this._handleNextUser.bind(this)),this._region.find('[data-action="change-user"]').on("change",this._refreshView.bind(this)),r(document).find('[data-region="website-info"]').on("click",this._leavepanel.bind(this))}return c.prototype._isLoading=!1,c.prototype._regionSelector=null,c.prototype._filters=null,c.prototype._users=null,c.prototype._region=null,c.prototype._gradeFeedbackChanged=null,c.prototype._loadAllUsers=function(){var e=this._region.find("[data-action=change-user]"),t=e.attr("data-websiteid"),e=e.attr("data-groupid");return n.call([{methodname:"mod_website_get_participants",args:{websiteid:t,groupid:e},done:this._setUsers.bind(this),fail:o.exception}]),!0},c.prototype._setUsers=function(e){this._users=JSON.parse(e.users)},c.prototype._handlePreviousUser=function(e){var t;e.preventDefault(),a.checkFormForChanges("#gradeform")?this._handleChangeUserHelper(e):(t=r("select.custom-select option").filter(":selected").val(),this._handlePreviousUser_helper(t),t=r("select.custom-select option").filter(":selected").val(),t=parseInt(t,10),this._refreshView(e,t,!0))},c.prototype._handlePreviousUser_helper=function(e){r(".custom-select option:selected").prev().attr("selected","selected"),r(`select.custom-select option[value='${e}']`).removeAttr("selected")},c.prototype._handleNextUser=function(e){e.preventDefault();var t=r(".custom-select option:selected").val(),o=r("select.custom-select option:last-child").val();a.checkFormForChanges("#gradeform")?t==o?this._handleChangeUserHelper(0):this._handleChangeUserHelper(e):(o=t==o?0:(this._handleNextUser_helper(t),r("select.custom-select option").filter(":selected").val()),this._refreshView(e,o,!0))},c.prototype._handleNextUser_helper=function(e){r("select.custom-select option:selected").next().attr("selected","selected"),r(`select.custom-select option[value='${e}']`).removeAttr("selected")},c.prototype.update_url=function(e){var t=new URL(window.location);t.searchParams.get("userid"),t.searchParams.set("userid",e),window.location=t},c.prototype._refreshView=function(e,t,o){0==(t=o?t:e.target.value)&&r("select.custom-select").val(t),t=parseInt(t,10),a.checkFormForChanges("#gradeform")?this._handleChangeUserHelper(t):(o||(r(".custom-select option").each(function(){r(this).removeAttr("selected")}),r(`select.custom-select option[value='${t}']`).attr("selected","selected")),r(document).trigger("user-changed",t),c.prototype.get_user_by_id(t),c.prototype.update_url(t))},c.prototype.get_user_by_id=function(e){var t=String(r('[data-region="user-info"]').data("websiteid"));n.call([{methodname:"mod_website_get_next_participant_details",args:{userid:e,websiteid:t},done:function(e){var t=r('[data-region="grade"]');t.fadeOut(300,function(){t.replaceWith(e.html),t.show(),r("#gradeform").on("submit",i.init()),a.saveFormState("#gradeform")})},fail:function(e){console.log("mod_website_get_participant_by_id. Unable to get elements"),console.log(e)}}])},c.prototype._leavepanel=function(e){var t=e.target.closest("a").getAttribute("href");a.checkFormForChanges("#gradeform")&&(e.preventDefault(),s.get_strings([{key:"unsavedchanges",component:"mod_website"},{key:"unsavedchangesquestion",component:"mod_website"},{key:"saveandcontinue",component:"mod_website"},{key:"cancel",component:"core"}]).done(function(e){o.confirm(e[0],e[1],e[2],e[3],function(){r("#gradeform").trigger("submit",[{direction:t}])},function(){r("#gradeform").trigger("reset")})}))},c.prototype._handleChangeUserHelper=function(t){s.get_strings([{key:"unsavedchanges",component:"mod_website"},{key:"unsavedchangesquestion",component:"mod_website"},{key:"saveandcontinue",component:"mod_website"},{key:"cancel",component:"core"}]).done(function(e){o.confirm(e[0],e[1],e[2],e[3],function(){null!=t.target?r("#gradeform").trigger("submit",[{direction:t.target.className}]):r("#gradeform").trigger("submit",[{userid:t}])},function(){r("#gradeform").trigger("reset")})})},c});